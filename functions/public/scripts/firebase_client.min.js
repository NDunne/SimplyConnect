$((function(){let e=firebase.firestore();const t=$("#head").text().split(" ").pop();var s,n={},o=!1,a=0,c="",i=!1,r=!1,d=[0,5,3,2,1];function l(){let e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",e+"px");var t=$(".circle").width();$(".circle").css({height:t+"px"}),window.innerHeight/screen.availHeight*100<60?$(".keyboard-hide").css({display:"none"}):$(".keyboard-hide").removeAttr("style")}function u(){var s=firebase.auth().currentUser;e.collection("Games").doc(t).update({"timer.running":!1,state:1.2,buzzer:s.uid,score:d[new_doc.clues]})}function h(e,t){return t?e/t:0}function f(e){var t=e.votes1.total,s=e.votes2.total,n=h(100,!!t+!!s);return[n*(h(e.votes1.for1,t)+h(e.votes2.for1,s)),n*(h(e.votes1.for2,t)+h(e.votes2.for2,s))]}function m(s){votes=f(s),$("#result_team1").css("background","linear-gradient(90deg, #9bee9b "+votes[0]+"%, #ee9b9b 0)"),$("#result_team2").css("background","linear-gradient(90deg, #9bee9b "+votes[1]+"%, #ee9b9b 0)"),query=e.collection("Users").where("Voted","==",!1).where("Game","==",t),query.get().then((function(e){e.size||$("#nextQ").show()}))}function v(e,t){e.text()!=t&&(e.text(t),e.css("color","9bee9b"),setTimeout((function(){e.css("color","initial")}),80))}function w(t){t.exists?(new_doc=t.data(),n!={}&&new_doc.state==n.state||(new_doc=function(t){var n=t.state;$(".state-cont").hide(),n>0&&($("#game-started").show(),$(".clue").removeClass("clue-flipped").find(".front").text("?"));1==n?($(".clue-flipped").removeClass("clue-flipped"),$(".clue-active").removeClass("clue-active").addClass("clue-inactive"),$("#timer").find("h2").text(45),$("#nextQ").hide(),r=!1,p(e=>0!=a).then((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Voted:!1})}))):1.1==n?($("#timer").show(),$(".q").addClass("question-inactive"),$(".q").removeClass("question-active"),$(".q").removeClass("question-selected"),t.clues=0):1.2==n?($("#state"+$.escapeSelector(1.1)).show(),clearInterval(s),$(".answer.right").removeClass("right").addClass("wrong"),p(e=>0!=a).then((function(){$(".box").hide();var e=firebase.auth().currentUser;r?(m(t.answers),$("#"+$.escapeSelector("ResultsBox1.2")).show()):e.uid==t.buzzer||(!t.turn%2&&1==a||t.turn%2&&2==a)&&i?$("#"+$.escapeSelector("AnswerBox1.2")).show():$("#"+$.escapeSelector("WaitBox1.2")).show()}))):5==n&&($("#round-head").text("Final Scores"),$("#round-desc").text("Thanks for Playing!"));return $("#state"+$.escapeSelector(n)).show(),t}(new_doc)),new_doc.state&&($(".q").addClass("question-inactive"),$(".q").removeClass("question-active"),$(".q").removeClass("question-selected"),p(e=>0!=a).then((function(){1==a?($("#head-t1").html("<b>Team 1</b>"),$("#head-t2").html("Team 2")):($("#head-t1").html("Team 1"),$("#head-t2").html("<b>Team 2</b>"))})),v($("#score-t1"),new_doc.scores.team1),v($("#score-t2"),new_doc.scores.team2)),0==new_doc.state&&(n=new_doc),1==new_doc.state?(n=new_doc,p(e=>0!=a).then((function(){if(new_doc.turn%2&&1==a||!(new_doc.turn%2)&&2==a){if(new_doc.questions!={})for(var e in new_doc.choices)new_doc.choices[e]&&($("#q"+e).removeClass("question-inactive"),$("#q"+e).addClass("question-active"),2==new_doc.choices[e]&&$("#q"+e).addClass("question-selected"));$("#helper-s1").text("Choose a Question")}else{for(var e in new_doc.choices)2==new_doc.choices[e]&&$("#q"+e).addClass("question-selected");$("#helper-s1").text("Other team is choosing...")}}))):1.1!=new_doc.state&&1.2!=new_doc.state||p(e=>0!=a).then((function(){if(1.2==new_doc.state)if($("#answer_team1").text(new_doc.answers.team1),$("#result_team1").text(new_doc.answers.team1),$("#answer_team2").text(new_doc.answers.team2),$("#result_team2").text(new_doc.answers.team2),""!=new_doc.answers.team1&&""!=new_doc.answers.team2)$(".solution-span").text(new_doc.questions.round1[new_doc.selected].answer),new_doc.clues<4&&(new_doc.clues=4),r?m(new_doc.answers):($(".box").hide(),$("#"+$.escapeSelector("VoteBox1.2")).show());else if(""!=new_doc.answers["team"+a])$(".box").hide(),$("#"+$.escapeSelector("WaitBox1.2")).show();else{var e=firebase.auth().currentUser;(new_doc.turn%2&&2==a||!(new_doc.turn%2)&&1==a)&&i||e.uid==new_doc.buzzer?($(".box").hide(),$("#"+$.escapeSelector("AnswerBox1.2")).show()):($(".box").hide(),$("#"+$.escapeSelector("WaitBox1.2")).show())}for(var t=1;t<=new_doc.clues;t++)$("#clue"+t).addClass("clue-flipped").find(".back").text(new_doc.questions.round1[new_doc.selected]["clue"+t]);var o;new_doc.turn%2&&1==a||!(new_doc.turn%2)&&2==a?(new_doc.clues?(o="Buzz when ready!",$("#buzz-button").addClass("enabled")):(o="Click first clue to start time",$("#buzz-button").removeClass("enabled")),$("#"+$.escapeSelector("helper-s1.1")).text(o),$("#"+$.escapeSelector("helper-s1.1-msgs")).text("Discuss your answer"),$("#clue"+(new_doc.clues+1)).removeClass("clue-inactive").addClass("clue-active"),$("#clue"+(new_doc.clues+1)).find(".front").text("Next"),$("#buzz-button").css("visibility","visible")):($("#"+$.escapeSelector("helper-s1.1")).text("Answer Correctly for a Bonus Point"),$("#"+$.escapeSelector("helper-s1.1-msgs")).text("Discuss your bonus point answer"),$("#buzz-button").css("visibility","hidden"));null!=n.timer&&n.timer.running||!new_doc.timer.running||(s=window.setInterval((function(){var e=45-(firebase.firestore.Timestamp.now().seconds-new_doc.timer.start);$("#timer").find("h2").text(("0"+Math.max(0,e)).slice(-2)),e<0&&u()}),1e3)),n=new_doc}))):$("#state-1").show()}function p(e){const t=s=>{e()?s():setTimeout(e=>t(s),400)};return new Promise(t)}function b(s,n,o=1,c=0,r=!1,d=!1){e.collection("Users").doc(s).set({DisplayName:n,Game:t,Team:o,Ready:c,Leader:r,Voted:d}).catch((function(e){console.log("Failed!"+e)})),g(n),i=r,a=o}function g(e){$("#dname").text(e),$("#changeDName").prop("disabled",!1),$("#readyUp").prop("disabled",!1),c=e}function _(s){o=!0,e.collection("Users").doc(s).get().then((function(e){e.exists?e.data().Game==t?b(s,e.data().DisplayName,e.data().Team,0,e.data().Leader,e.data().Voted):b(s,e.data().DisplayName):b(s,s.substring(1,6))})),e.collection("Users").doc(s).onSnapshot((function(e){e.exists&&e.data().Voted?(r=!0,$("#"+$.escapeSelector("VoteBox1.2")).hide(),$("#"+$.escapeSelector("ResultsBox1.2")).show(),n.answers&&m(n.answers)):r=!1}))}function x(e){return"#"+(e.replace(/[^0-9A-F]/g,"")+"000000").substring(0,6)}function y(t,s,n){firebase.auth().currentUser.uid==s&&(i=n),t.update(e.collection("Users").doc(s),{Leader:n})}async function C(){for(var s=[],n=0;n<4;n++)s[n]=e.collection("Questions").doc("round"+(n+1)).get();s=await Promise.all(s);var o={round1:function(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*t),n=e[t];e[t]=e[s],e[s]=n}return e}((s=s.map((function(e){return e.data().questions.text})))[0]).slice(0,6).reduce((function(e,t,s,n){return e["ABCDEF"[s]]=t,e}),{}),round2:{},round3:{},round4:{}};e.collection("Games").doc(t).update({questions:o})}l(),$(window).resize((function(){l()})),jQuery.fn.swapWith=function(e){return this.each((function(){var t=$(e).clone(!0),s=$(this).clone(!0);$(e).replaceWith(s),$(this).replaceWith(t)}))},e.collection("Games").doc(t).onSnapshot((function(e){o||function(){firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);var e=firebase.auth().currentUser;e?_(e.uid):firebase.auth().signInAnonymously()}(),w(e)})),p(e=>0!=a).then((function(){e.collection("Chats").doc(t+"_"+a).onSnapshot((function(e){if($("#messages").html(""),messages=e.data(),messages){var t=$("#"+$.escapeSelector("chat-s1.1")).height();e.data().msgs.forEach(e=>{$("#messages").append('\n              <div class="msg">\n                <div class="icon '+e.shape+' smaller" style="background: '+e.col+'"></div>\n                <div class="msgname">'+e.sender+': </div>\n                <div class="msgcontent">\n                '+e.content+"\n                </div>\n               </div>\n            ")}),$("#"+$.escapeSelector("chat-s1.1")).height(t)}}))})),firebase.auth().onAuthStateChanged((function(e){e&&_(e.uid)})),e.collection("Users").orderBy("Leader","desc").where("Game","==",t).onSnapshot((function(t){p(e=>!jQuery.isEmptyObject(n)).then((function(){0==n.state&&function(t){var s=[],n=[],o=firebase.auth().currentUser;if(!o)return $("#joinT2").prop("disabled",!0),void $("#joinT1").prop("disabled",!0);var a=0,c=e.batch();t.forEach((function(e){var t=e.data().DisplayName,i="";e.data().Ready%2&&(i="&#10004;",a++);var r=x(e.id);if(1==e.data().Team){var d="circle";s.length?y(c,e.id,!1):(d="crown",y(c,e.id,!0)),s.push('<div id="'+e.id+'" class="name">\n          <div class="icon '+d+'" style="background: '+r+'"></div>\n          <div>&nbsp;'+t+i+"</div>\n        </div>"),e.id==o.uid&&($("#joinT2").prop("disabled",!1),$("#joinT1").prop("disabled",!0))}else{d="circle";n.length?y(c,e.id,!1):(d="crown",y(c,e.id,!0)),n.push('<div id="'+e.id+'" class="name-end">\n          <div>'+i+t+'&nbsp;</div>\n          <div class="icon '+d+'" style="background: '+r+'"></div>\n        </div>'),e.id==o.uid&&($("#joinT1").prop("disabled",!1),$("#joinT2").prop("disabled",!0))}})),c.commit(),a==t.size&&s.length>0&&n.length>0?$("#start").prop("disabled",!1):$("#start").prop("disabled",!0);var i=Math.max(s.length,n.length);$("#teamsTab").find("tr:gt(1)").remove();for(var r=0;r<i;r++){var d="",l="";r<s.length&&(d=s[r]),r<n.length&&(l=n[r]),$("#teamsTab").append("<tr><td>"+d+"</td><td></td><td>"+l+"</td></tr>")}}(t)}))})),$(".home-but").click((function(){$(location).attr("href","/")})),$(".restart-but").click((function(){})),$("#top").click((function(){$(location).attr("href","/")})),$("#changeDName").click((function(){var t=firebase.auth().currentUser,s=$("#newDName").val();g(s),$("#newDName").val(""),e.collection("Users").doc(t.uid).update({DisplayName:s})})),$("#joinT1").click((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Team:1,Leader:!1}),a=1})),$("#joinT2").click((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Team:2,Leader:!1}),a=2})),$("#readyUp").click((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Ready:firebase.firestore.FieldValue.increment(1)})})),$("#start").click((function(){var s=Math.floor(2*Math.random());e.collection("Games").doc(t).update({turn:s,state:1}),C()})),$("#makeLeader").click((function(){e.collection("Users").where("Team","==",a).where("Leader","==",!0).get().then(t=>{var s=e.batch();t.docs.forEach(e=>{y(s,e.id,!1)});var n=firebase.auth().currentUser;y(s,n.uid,!0),s.commit()})})),$(document).on("click",".question-active",(function(){for(var s in $(".question-selected").removeClass("question-selected"),$(this).addClass("question-selected"),n.choices)2==n.choices[s]&&(n.choices[s]=1);var o=$(this).attr("id").substring(1);n.choices[o]=2,e.collection("Games").doc(t).update({choices:n.choices})})),$(document).on("click",".question-selected",(function(){var s=$(this).attr("id").substring(1);e.collection("Games").doc(t).update({selected:s,["choices."+s]:0,state:1.1})})),$(document).on("click",".clue-active",(function(){$(this).removeClass("clue-active").addClass("clue-inactive"),e.collection("Games").doc(t).update({clues:firebase.firestore.FieldValue.increment(1)})})),$(document).on("click","#clue1.clue-active",(function(){e.collection("Games").doc(t).update({timer:{running:!0,start:firebase.firestore.Timestamp.now().seconds}})})),$(document).on("click","#buzz-button.enabled",(function(){u()})),$("#submitAnswer").click((function(){firebase.auth().currentUser;e.collection("Games").doc(t).update({["answers.team"+a]:$("#answerBox").val()}),$("#answerBox").val("")})),$(document).on("click",".answer.wrong, .answer.right",(function(){$(this).toggleClass("wrong").toggleClass("right")})),$("#confirmVote").click((function(){var s=e.batch(),n=e.collection("Games").doc(t);$(".answer.right").each((function(e){s.update(n,{["answers.votes"+a+".for"+$(this).attr("id").slice(-1)]:firebase.firestore.FieldValue.increment(1)})})),s.update(n,{["answers.votes"+a+".total"]:firebase.firestore.FieldValue.increment(1)});var o=firebase.auth().currentUser;s.update(e.collection("Users").doc(o.uid),{Voted:!0}),s.commit()})),$("#skipVote").click((function(){var s=e.batch(),n=firebase.auth().currentUser,o=e.collection("Games").doc(t);s.update(o,{["answers.votes"+a+".total"]:firebase.firestore.FieldValue.increment(0)}),s.update(e.collection("Users").doc(n.uid),{Voted:!0}),s.commit()})),$("#nextQ").click((function(){var s=f(n.answers),o=e.collection("Games").doc(t);return o.update({state:1,turn:firebase.firestore.FieldValue.increment(1),timer:{running:!1,start:0},answers:{team1:"",votes1:{for1:0,for2:0,total:0},team2:"",votes2:{for1:0,for2:0,total:0}},selected:""}),e.runTransaction((function(e){return e.get(o).then((function(t){var n=t.data().choices;n[t.data().selected]=0,Object.values(n).reduce((e,t)=>e+t)||e.update(o,{state:5});var a=s[0]>=50?t.data().turn%2?1:t.data().score:0,c=s[1]>=50?t.data().turn%2?t.data().score:1:0;e.update(o,{clues:0,scores:{team1:t.data().scores.team1+a,team2:t.data().scores.team2+c}})}))})).then((function(){console.log("Transaction successfully committed!")})).catch((function(e){console.log("Transaction failed: ",e)}))})),$(document).keyup((function(s){if($("#sendbox").is(":focus")&&"Enter"==s.key){var n=firebase.auth().currentUser;e.collection("Chats").doc(t+"_"+a).set({msgs:firebase.firestore.FieldValue.arrayUnion({col:x(n.uid),sender:c,content:" "+$("#sendbox").val(),shape:i?"crown":"circle"})},{merge:!0}),$("#sendbox").val("")}}))}));
