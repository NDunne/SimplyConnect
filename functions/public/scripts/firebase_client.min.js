$((function(){let e=firebase.firestore();const t=$("#head").text().split(" ").pop();var o,s={},n=!1,c=0,a="",i=!1,r=!1,l=[0,5,3,2,1];function d(){let e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",e+"px");var t=$(".circle").width();$(".circle").css({height:t+"px"}),window.innerHeight/screen.availHeight*100<60?$(".keyboard-hide").css({display:"none"}):$(".keyboard-hide").removeAttr("style")}function u(){var o=firebase.auth().currentUser;e.collection("Games").doc(t).update({"timer.running":!1,state:1.2,buzzer:o.uid,score:l[new_doc.clues]})}function h(e,t){return t?e/t:0}function f(e){var t=e.votes1.total,o=e.votes2.total,s=h(100,!!t+!!o);return[s*(h(e.votes1.for1,t)+h(e.votes2.for1,o)),s*(h(e.votes1.for2,t)+h(e.votes2.for2,o))]}function m(o){console.log(o),votes=f(o),console.log(votes[0]+" "+votes[1]),$("#result_team1").css("background","linear-gradient(90deg, #9bee9b "+votes[0]+"%, #ee9b9b 0)"),$("#result_team2").css("background","linear-gradient(90deg, #9bee9b "+votes[1]+"%, #ee9b9b 0)"),query=e.collection("Users").where("Voted","==",!1).where("Game","==",t),query.get().then((function(e){console.log("size: "+e.size),e.size||$("#nextQ").show()}))}function v(e,t){e.text()!=t&&(e.text(t),e.css("color","#00FF00"),setTimeout((function(){e.css("color","initial")}),50))}function w(t){console.log("Game Updated"),t.exists?(new_doc=t.data(),console.log(s),console.log(new_doc),console.log(""),s!={}&&new_doc.state==s.state||(new_doc=function(t){console.log("updateState");var s=t.state;$(".state-cont").hide(),s>0&&($("#game-started").show(),$(".clue").removeClass("clue-flipped").find(".front").text("?"));1==s?($(".clue-flipped").removeClass("clue-flipped"),$(".clue-active").removeClass("clue-active").addClass("clue-inactive"),$("#timer").find("h2").text(45),$("#nextQ").hide(),r=!1,p(e=>0!=c).then((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Voted:!1})}))):1.1==s?($("#timer").show(),$(".q").addClass("question-inactive"),$(".q").removeClass("question-active"),$(".q").removeClass("question-selected"),t.clues=0):1.2==s?($("#state"+$.escapeSelector(1.1)).show(),clearInterval(o),$(".answer.right").removeClass("right").addClass("wrong"),p(e=>0!=c).then((function(){$(".box").hide();var e=firebase.auth().currentUser;r?(m(t.answers),$("#"+$.escapeSelector("ResultsBox1.2")).show()):e.uid==t.buzzer||(!t.turn%2&&1==c||t.turn%2&&2==c)&&i?$("#"+$.escapeSelector("AnswerBox1.2")).show():$("#"+$.escapeSelector("WaitBox1.2")).show()}))):5==s&&($("#round-head").text("Final Scores"),$("#round-desc").text("Thanks for Playing!"));return $("#state"+$.escapeSelector(s)).show(),t}(new_doc)),new_doc.state&&($(".q").addClass("question-inactive"),$(".q").removeClass("question-active"),$(".q").removeClass("question-selected"),p(e=>0!=c).then((function(){1==c?($("#head-t1").html("<b>Team 1</b>"),$("#head-t2").html("Team 2")):($("#head-t1").html("Team 1"),$("#head-t2").html("<b>Team 2</b>"))})),v($("#score-t1"),new_doc.scores.team1),v($("#score-t2"),new_doc.scores.team2)),0==new_doc.state&&(s=new_doc),1==new_doc.state?(s=new_doc,p(e=>0!=c).then((function(){if(new_doc.turn%2&&1==c||!(new_doc.turn%2)&&2==c){if(new_doc.questions!={})for(var e in new_doc.choices)new_doc.choices[e]&&($("#q"+e).removeClass("question-inactive"),$("#q"+e).addClass("question-active"),2==new_doc.choices[e]&&($("#q"+e).addClass("question-selected"),console.log("selected: "+e)));$("#helper-s1").text("Choose a Question")}else{for(var e in new_doc.choices)2==new_doc.choices[e]&&($("#q"+e).addClass("question-selected"),console.log("selected: "+e));$("#helper-s1").text("Other team is choosing...")}}))):1.1!=new_doc.state&&1.2!=new_doc.state||p(e=>0!=c).then((function(){if(1.2==new_doc.state)if(console.log("state 1.2"),$("#answer_team1").text(new_doc.answers.team1),$("#result_team1").text(new_doc.answers.team1),$("#answer_team2").text(new_doc.answers.team2),$("#result_team2").text(new_doc.answers.team2),""!=new_doc.answers.team1&&""!=new_doc.answers.team2)$(".solution-span").text(new_doc.questions.round1[new_doc.selected].answer),new_doc.clues<4&&(new_doc.clues=4),r?(console.log("recolour"),m(new_doc.answers)):($(".box").hide(),$("#"+$.escapeSelector("VoteBox1.2")).show());else if(""!=new_doc.answers["team"+c])$(".box").hide(),$("#"+$.escapeSelector("WaitBox1.2")).show();else{var e=firebase.auth().currentUser;(new_doc.turn%2&&2==c||!(new_doc.turn%2)&&1==c)&&i||e.uid==new_doc.buzzer?($(".box").hide(),$("#"+$.escapeSelector("AnswerBox1.2")).show()):($(".box").hide(),$("#"+$.escapeSelector("WaitBox1.2")).show())}console.log("Clues: "+new_doc.clues);for(var t=1;t<=new_doc.clues;t++)$("#clue"+t).addClass("clue-flipped").find(".back").text(new_doc.questions.round1[new_doc.selected]["clue"+t]);var n;new_doc.turn%2&&1==c||!(new_doc.turn%2)&&2==c?(new_doc.clues?(n="Buzz when ready!",$("#buzz-button").addClass("enabled")):(n="Click first clue to start time",$("#buzz-button").removeClass("enabled")),$("#"+$.escapeSelector("helper-s1.1")).text(n),$("#"+$.escapeSelector("helper-s1.1-msgs")).text("Discuss your answer"),$("#clue"+(new_doc.clues+1)).removeClass("clue-inactive").addClass("clue-active"),$("#clue"+(new_doc.clues+1)).find(".front").text("Next"),$("#buzz-button").css("visibility","visible")):($("#"+$.escapeSelector("helper-s1.1")).text("Answer Correctly for a Bonus Point"),$("#"+$.escapeSelector("helper-s1.1-msgs")).text("Discuss your bonus point answer"),$("#buzz-button").css("visibility","hidden"));console.log(s.timer),console.log(new_doc.timer),null!=s.timer&&s.timer.running||!new_doc.timer.running||(o=window.setInterval((function(){console.log("TICK");var e=45-(firebase.firestore.Timestamp.now().seconds-new_doc.timer.start);$("#timer").find("h2").text(("0"+Math.max(0,e)).slice(-2)),e<0&&u()}),1e3)),s=new_doc}))):$("#state-1").show()}function p(e){const t=o=>{e()?o():setTimeout(e=>t(o),400)};return new Promise(t)}function b(o,s,n=1,a=0,r=!1,l=!1){e.collection("Users").doc(o).set({DisplayName:s,Game:t,Team:n,Ready:a,Leader:r,Voted:l}).catch((function(e){console.log("Failed!"+e)})),g(s),i=r,c=n}function g(e){$("#dname").text(e),$("#changeDName").prop("disabled",!1),$("#readyUp").prop("disabled",!1),a=e}function _(o){n=!0,e.collection("Users").doc(o).get().then((function(e){e.exists?e.data().Game==t?b(o,e.data().DisplayName,e.data().Team,0,e.data().Leader,e.data().Voted):b(o,e.data().DisplayName):b(o,o.substring(1,6))})),e.collection("Users").doc(o).onSnapshot((function(e){e.exists&&e.data().Voted?(console.log("Updated voted"),r=!0,$("#"+$.escapeSelector("VoteBox1.2")).hide(),$("#"+$.escapeSelector("ResultsBox1.2")).show(),s.answers&&m(s.answers)):r=!1}))}function x(e){return"#"+(e.replace(/[^0-9A-F]/g,"")+"000000").substring(0,6)}function y(t,o,s){firebase.auth().currentUser.uid==o&&(i=s),t.update(e.collection("Users").doc(o),{Leader:s})}async function C(){for(var o=[],s=0;s<4;s++)o[s]=e.collection("Questions").doc("round"+(s+1)).get();o=await Promise.all(o),console.log(o);o=o.map((function(e){return e.data().questions.text})),console.log(o);var n={round1:function(e){for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*t),s=e[t];e[t]=e[o],e[o]=s}return e}(o[0]).slice(0,6).reduce((function(e,t,o,s){return e["ABCDEF"[o]]=t,e}),{}),round2:{},round3:{},round4:{}};e.collection("Games").doc(t).update({questions:n})}d(),$(window).resize((function(){d()})),jQuery.fn.swapWith=function(e){return this.each((function(){var t=$(e).clone(!0),o=$(this).clone(!0);$(e).replaceWith(o),$(this).replaceWith(t)}))},console.log(s),e.collection("Games").doc(t).onSnapshot((function(e){n||function(){firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);var e=firebase.auth().currentUser;e?_(e.uid):firebase.auth().signInAnonymously()}(),w(e)})),p(e=>0!=c).then((function(){e.collection("Chats").doc(t+"_"+c).onSnapshot((function(e){if($("#messages").html(""),messages=e.data(),messages){var t=$("#"+$.escapeSelector("chat-s1.1")).height();e.data().msgs.forEach(e=>{$("#messages").append('\n              <div class="msg">\n                <div class="icon '+e.shape+' smaller" style="background: '+e.col+'"></div>\n                <div class="msgname">'+e.sender+': </div>\n                <div class="msgcontent">\n                '+e.content+"\n                </div>\n               </div>\n            ")}),$("#"+$.escapeSelector("chat-s1.1")).height(t)}}))})),firebase.auth().onAuthStateChanged((function(e){console.log("AUTH STATE CHANGED: "+e),e&&_(e.uid)})),e.collection("Users").orderBy("Leader","desc").where("Game","==",t).onSnapshot((function(t){console.log("ld: "+JSON.stringify(s)+" "+jQuery.isEmptyObject("state")),p(e=>!jQuery.isEmptyObject(s)).then((function(){console.log("ld: "+JSON.stringify(s)+" "+jQuery.isEmptyObject("state")),0==s.state&&function(t){console.log("updateTeams");var o=[],s=[],n=firebase.auth().currentUser;if(!n)return $("#joinT2").prop("disabled",!0),void $("#joinT1").prop("disabled",!0);var c=0,a=e.batch();t.forEach((function(e){var t=e.data().DisplayName,i="";e.data().Ready%2&&(i="&#10004;",c++);var r=x(e.id);if(1==e.data().Team){var l="circle";o.length?y(a,e.id,!1):(l="crown",y(a,e.id,!0)),o.push('<div id="'+e.id+'" class="name">\n          <div class="icon '+l+'" style="background: '+r+'"></div>\n          <div>&nbsp;'+t+i+"</div>\n        </div>"),e.id==n.uid&&($("#joinT2").prop("disabled",!1),$("#joinT1").prop("disabled",!0))}else{l="circle";s.length?y(a,e.id,!1):(l="crown",y(a,e.id,!0)),s.push('<div id="'+e.id+'" class="name-end">\n          <div>'+i+t+'&nbsp;</div>\n          <div class="icon '+l+'" style="background: '+r+'"></div>\n        </div>'),e.id==n.uid&&($("#joinT1").prop("disabled",!1),$("#joinT2").prop("disabled",!0))}})),a.commit(),c==t.size&&o.length>0&&s.length>0?$("#start").prop("disabled",!1):$("#start").prop("disabled",!0);var i=Math.max(o.length,s.length);$("#teamsTab").find("tr:gt(1)").remove();for(var r=0;r<i;r++){var l="",d="";r<o.length&&(l=o[r]),r<s.length&&(d=s[r]),$("#teamsTab").append("<tr><td>"+l+"</td><td></td><td>"+d+"</td></tr>")}}(t)}))})),$(".home-but").click((function(){$(location).attr("href","/")})),$(".restart-but").click((function(){})),$("#top").click((function(){$(location).attr("href","/")})),$("#changeDName").click((function(){var t=firebase.auth().currentUser,o=$("#newDName").val();g(o),$("#newDName").val(""),e.collection("Users").doc(t.uid).update({DisplayName:o})})),$("#joinT1").click((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Team:1,Leader:!1}),c=1})),$("#joinT2").click((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Team:2,Leader:!1}),c=2})),$("#readyUp").click((function(){var t=firebase.auth().currentUser;e.collection("Users").doc(t.uid).update({Ready:firebase.firestore.FieldValue.increment(1)})})),$("#start").click((function(){var o=Math.floor(2*Math.random());e.collection("Games").doc(t).update({turn:o,state:1}),C()})),$("#makeLeader").click((function(){e.collection("Users").where("Team","==",c).where("Leader","==",!0).get().then(t=>{var o=e.batch();t.docs.forEach(e=>{y(o,e.id,!1)});var s=firebase.auth().currentUser;y(o,s.uid,!0),o.commit()})})),$(document).on("click",".question-active",(function(){for(var o in $(".question-selected").removeClass("question-selected"),$(this).addClass("question-selected"),s.choices)2==s.choices[o]&&(s.choices[o]=1);var n=$(this).attr("id").substring(1);s.choices[n]=2,e.collection("Games").doc(t).update({choices:s.choices})})),$(document).on("click",".question-selected",(function(){var o=$(this).attr("id").substring(1);e.collection("Games").doc(t).update({selected:o,["choices."+o]:0,state:1.1})})),$(document).on("click",".clue-active",(function(){$(this).removeClass("clue-active").addClass("clue-inactive"),e.collection("Games").doc(t).update({clues:firebase.firestore.FieldValue.increment(1)})})),$(document).on("click","#clue1.clue-active",(function(){e.collection("Games").doc(t).update({timer:{running:!0,start:firebase.firestore.Timestamp.now().seconds}})})),$(document).on("click","#buzz-button.enabled",(function(){u()})),$("#submitAnswer").click((function(){firebase.auth().currentUser;e.collection("Games").doc(t).update({["answers.team"+c]:$("#answerBox").val()}),$("#answerBox").val("")})),$(document).on("click",".answer.wrong, .answer.right",(function(){$(this).toggleClass("wrong").toggleClass("right")})),$("#confirmVote").click((function(){var o=e.batch(),s=e.collection("Games").doc(t);$(".answer.right").each((function(e){o.update(s,{["answers.votes"+c+".for"+$(this).attr("id").slice(-1)]:firebase.firestore.FieldValue.increment(1)}),console.log()})),o.update(s,{["answers.votes"+c+".total"]:firebase.firestore.FieldValue.increment(1)});var n=firebase.auth().currentUser;o.update(e.collection("Users").doc(n.uid),{Voted:!0}),o.commit()})),$("#skipVote").click((function(){var o=e.batch(),s=firebase.auth().currentUser,n=e.collection("Games").doc(t);o.update(n,{["answers.votes"+c+".total"]:firebase.firestore.FieldValue.increment(0)}),o.update(e.collection("Users").doc(s.uid),{Voted:!0}),o.commit()})),$("#nextQ").click((function(){var o=f(s.answers);console.log(o);var n=e.collection("Games").doc(t);return n.update({state:1,turn:firebase.firestore.FieldValue.increment(1),timer:{running:!1,start:0},answers:{team1:"",votes1:{for1:0,for2:0,total:0},team2:"",votes2:{for1:0,for2:0,total:0}},selected:""}),e.runTransaction((function(e){return e.get(n).then((function(t){var s=t.data().choices;s[t.data().selected]=0;var c=Object.values(s).reduce((e,t)=>e+t);console.log("SUM"+c),c||e.update(n,{state:5}),console.log("Clues: "+t.data().clues+" Score: "+t.data().score);var a=o[0]>=50?t.data().turn%2?1:t.data().score:0,i=o[1]>=50?t.data().turn%2?t.data().score:1:0;console.log("scores: "+a+" "+i),e.update(n,{clues:0,scores:{team1:t.data().scores.team1+a,team2:t.data().scores.team2+i}})}))})).then((function(){console.log("Transaction successfully committed!")})).catch((function(e){console.log("Transaction failed: ",e)}))})),$(document).keyup((function(o){if($("#sendbox").is(":focus")&&"Enter"==o.key){var s=firebase.auth().currentUser;console.log(i),e.collection("Chats").doc(t+"_"+c).set({msgs:firebase.firestore.FieldValue.arrayUnion({col:x(s.uid),sender:a,content:" "+$("#sendbox").val(),shape:i?"crown":"circle"})},{merge:!0}),$("#sendbox").val("")}}))}));
